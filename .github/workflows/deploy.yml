name: wxread

description: å¾®ä¿¡è¯»ä¹¦æ™ºèƒ½é˜…è¯»æœºå™¨äººï¼ˆv2.5.0ï¼‰

on:
  schedule:
    - cron: '0 21 * * *'  # 05:00
    - cron: '40 3 * * *'  # 11:40
    - cron: '00 14 * * *' # 21:30-22:00
    - cron: '0 9 * * sat' # å‘¨å…­ 09:00
    - cron: '0 9 * * sun' # å‘¨æ—¥ 09:00
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/manual)'
        required: false
        default: 'auto'
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ (true/false)'
        required: false
        default: 'false'

env:
  DNS_SERVER_1: 8.8.8.8
  DNS_SERVER_2: 8.8.4.4
  PYTHON_VERSION: '3.10'
  BASE_MINUTES: $((3 * 60 + 30))
  FLOAT_MINUTES: 30
  WEEKEND_MIN: 90
  WEEKEND_MAX: 190
  RANDOM_DELAY_MIN: 25  # æœ€å°éšæœºå»¶è¿Ÿï¼ˆç§’ï¼‰
  RANDOM_DELAY_MAX: 35  # æœ€å¤§éšæœºå»¶è¿Ÿï¼ˆç§’ï¼‰

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
    - name: è®¾ç½® DNS
      run: |
        echo -e "\n\033[1;34mğŸŒ DNS Configuration\033[0m"
        echo -e "nameserver $DNS_SERVER_1" | sudo tee /etc/resolv.conf
        echo -e "nameserver $DNS_SERVER_2" | sudo tee -a /etc/resolv.conf
        echo -e "\033[1;32mâœ… DNS setup completed\033[0m"

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        submodules: recursive

    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      id: cache
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: è®¾ç½® Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: x64
        cache: pip

    - name: å®‰è£…ä¾èµ–
      run: |
        echo -e "\n\033[1;34mğŸ“¦ Dependency Installation\033[0m"
        python -m pip install --upgrade pip wheel
        pip install -r requirements.txt --user
        echo -e "\033[1;32mğŸ“¦ Dependencies installed\033[0m"
        pip list

    - name: æ³¨å…¥ç¯å¢ƒå˜é‡
      run: |
        echo -e "\n\033[1;34mğŸ”§ Environment Setup\033[0m"
        echo "WXREAD_KEY=${{ secrets.WXREAD_KEY }}" >> $GITHUB_ENV
        echo "WXREAD_COOKIES=${{ secrets.WXREAD_COOKIES }}" >> $GITHUB_ENV
        echo "WXREAD_HEADERS=${{ secrets.WXREAD_HEADERS }}" >> $GITHUB_ENV
        echo "WXREAD_PUSH_METHOD=${{ secrets.WXREAD_PUSH_METHOD }}" >> $GITHUB_ENV
        echo "WXREAD_READ_NUM=${{ env.READ_NUM }}" >> $GITHUB_ENV

    - name: éšæœºå»¶è¿Ÿ
      if: github.event_name == 'schedule'
      run: |
        echo -e "\n\033[1;34mâ³ Random Delay\033[0m"
        DELAY=$((RANDOM % 21))
        echo -e "Delay: \033[1;36m${DELAY} minutes\033[0m"
        sleep $((DELAY * 60))
        echo -e "\033[1;32mâ³ Delay completed\033[0m"

    - name: ç”Ÿæˆ READ_NUM
      run: |
        echo -e "\n\033[1;34mğŸ“Š Reading Time Calculation\033[0m"
        echo -e "Event type: \033[1;36m${{ github.event_name }}\033[0m"
        echo -e "Mode: \033[1;36m${{ github.event.inputs.mode }}\033[0m"
        
        if [[ "${{ github.event.inputs.mode }}" == "manual" ]]; then
          DELAY=0
        fi
        
        if [[ "${{ github.event_name }}" == "schedule" && ( "${{ github.event.schedule }}" == "0 9 * * sat" || "${{ github.event.schedule }}" == "0 9 * * sun" ) ]]; then
          READ_NUM=$((RANDOM % ($WEEKEND_MAX - $WEEKEND_MIN + 1) + $WEEKEND_MIN))
          echo -e "Weekend mode: \033[1;36m$((WEEKEND_MIN / 2))-$((WEEKEND_MAX / 2)) minutes\033[0m"
        else:
          READ_NUM=$((RANDOM % (2 * $FLOAT_MINUTES + 1) + $BASE_MINUTES - $FLOAT_MINUTES))
          READ_NUM=$((READ_NUM * 2))
          echo -e "Weekday mode: \033[1;36m$((BASE_MINUTES - FLOAT_MINUTES))-$((BASE_MINUTES + FLOAT_MINUTES)) minutes\033[0m"
        fi
        
        echo -e "\n\033[1;32mğŸ“– Final READ_NUM:\033[0m \033[1;36m${{ env.READ_NUM }}\033[0m ($((env.READ_NUM / 2)) minutes)"
        echo "READ_NUM=$READ_NUM" >> $GITHUB_ENV

    - name: æ‰§è¡Œä¸»ç¨‹åº
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
      run: |
        echo -e "\n\033[1;34mğŸš€ Main Program Execution\033[0m"
        echo -e "Parameters:"
        echo -e "  ğŸ•’ READ_NUM: \033[1;36m${{ env.READ_NUM }}\033[0m"
        echo -e "  â±ï¸ RANDOM_DELAY: \033[1;36m$RANDOM_DELAY_MIN-$RANDOM_DELAY_MAX seconds\033[0m"
        
        echo -e "\n\033[1;32mâœ… Execution started\033[0m"
        python main.py --config config.yml
        
        echo -e "\n\033[1;32mâœ… Execution completed\033[0m"

    - name: æ¸…ç†ç¯å¢ƒ
      run: |
        echo -e "\n\033[1;34mğŸ§¹ Environment Cleanup\033[0m"
        rm -rf ~/.cache/pip
        sudo rm -rf /tmp/*
        echo -e "\033[1;32mğŸ—‘ï¸ Cleanup completed\033[0m"

    - name: å‘é€æ‰§è¡ŒæŠ¥å‘Š
      uses: actions-simple/slack-notify@v1
      if: always()
      with:
        status: ${{ job.status }}
        channels: '#reading-bots'
        username: AutoReader
        icon_url: https://avatars.githubusercontent.com/u/12345678
        payload: |
          {
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":books: *å¾®ä¿¡è¯»ä¹¦ä»»åŠ¡æ‰§è¡ŒæŠ¥å‘Š*"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“… ä»»åŠ¡æ—¶é—´:*\n${{ github.run_started_at }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ”„ é˜…è¯»æ—¶é•¿:*\n$((env.READ_NUM / 2))åˆ†é’Ÿ"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ”— ä»»åŠ¡é“¾æ¥:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|æŸ¥çœ‹è¯¦ç»†æ—¥å¿—>"
                }
              }
            ]
          }
        secrets: ${{ secrets.SLACK_TOKEN }}
